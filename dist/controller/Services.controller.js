sap.ui.define(["sap/ui/core/mvc/Controller","com/ServicesProviders/ServicesProviders/util/formatter","sap/m/MessageBox","sap/ui/export/library","sap/ui/export/Spreadsheet"],function(e,t,r,o,i){"use strict";var s=o.EdmType;return e.extend("com.ServicesProviders.ServicesProviders.controller.Services",{formatter:t,onInit:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("Services").attachMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){this.getView().byId("servicesTable").getBinding("rows").refresh()},handleClose:function(){var e=this.getOwnerComponent().getRouter();e.navTo("Home")},onServiceProviderPress:function(){var e=this.getOwnerComponent().getRouter();e.navTo("ServiceProvider")},onServiceProviderDetailPress:function(){var e=this.getOwnerComponent().getRouter();e.navTo("ServiceProviderDetail")},onSearch:function(){this.onGoPress()},onGoPress:function(e){var t=this.getView().byId("servicesTable");var r=this.getView();var o=r.byId("servicesnameinput").getValue();var i=r.byId("mydeleteditems").getSelectedKey();var s=r.byId("mydeleteditems").getSelectedItem();var n="";if(s){n=s.getText()||""}var a=[];if(o.length>0){var l=new sap.ui.model.Filter("tolower(SERVICE_NAME)",sap.ui.model.FilterOperator.Contains,"tolower('"+this.getView().byId("servicesnameinput").getValue()+"')");a.push(l)}if(n=="Deleted"){var c=new sap.ui.model.Filter("DELETIONFLAG",sap.ui.model.FilterOperator.Contains,i);a.push(c)}else if(n=="Non-Deleted"){var d=new sap.ui.model.Filter("DELETIONFLAG",sap.ui.model.FilterOperator.NE,"X");a.push(d)}var g=r.byId("servicesTable").getBinding("rows");if(o.length===0&&n===""){g.filter([])}else{g.filter(a.length>0?new sap.ui.model.Filter(a,true):[])}},createColumnConfig:function(){var e=[];e.push({label:"ID",property:["SERVICE_ID"],type:s.Number,template:"{0}, {1}"});e.push({label:"Provider Name",type:s.String,property:"SERVICE_NAME"});e.push({property:"SERVICE_DESCRIPTION",type:s.String});e.push({property:"SERVICECATEGORY_ID",type:s.String});e.push({property:"CREATIONDATETIME",type:s.Date});e.push({property:"CREATEDBY",type:s.String});e.push({property:"UPDATEDATETIME",type:s.Date});e.push({property:"UPDATEDBY",type:s.String});e.push({property:"DELETIONFLAG",type:s.String});return e},changeStateUpdateService:function(e){var t=e.getSource();var r=t.getState();var o=r?"Are you sure you want to delete the provider?":"Are you sure you want to undo-delete the provider?";var i=r?"Confirm Deletion":"Confirm Undo-Deletion";sap.m.MessageBox.confirm(o,{title:i,actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){if(r){console.log("Provider deleted.")}else{console.log("Undo-delete operation performed.")}}else{t.setState(!r)}}})},onExport:function(){var e,t,r,o,s;if(!this._oTable){this._oTable=this.byId("servicesTable")}s=this._oTable;t=s.getBinding("rows");e=this.createColumnConfig();r={workbook:{count:5,columns:e,hierarchyLevel:"Level"},dataSource:t,type:"odata",fileName:"Service Master.xlsx",worker:false};o=new i(r);o.build().finally(function(){o.destroy()})},onEditPress:function(){this.oSelectedItem=this.getView().byId("servicesTable").getSelectedIndex();if(this.oSelectedItem<0){r.error("Please Select a Service to Proceed")}else{this.selectedItem=this.getView().byId("servicesTable").getContextByIndex(this.oSelectedItem).getObject();if(!this.UpdateService){this.UpdateService=new sap.ui.xmlfragment("com.ServicesProviders.ServicesProviders.fragments.UpdateService",this);this.getView().addDependent(this.UpdateService)}var e=true;if(this.selectedItem.DELETIONFLAG=="X"){e=true}else{e=false}this.UpdateService.getContent()[0].getFormContainers()[0].getFormElements()[0].getFields()[0].setValue(this.selectedItem.SERVICE_NAME);this.UpdateService.getContent()[0].getFormContainers()[0].getFormElements()[1].getFields()[0].setValue(this.selectedItem.SERVICE_DESCRIPTION);this.UpdateService.getContent()[0].getFormContainers()[0].getFormElements()[2].getFields()[0].setSelectedKey(this.selectedItem.SERVICECATEGORY_ID);this.UpdateService.getContent()[0].getFormContainers()[0].getFormElements()[3].getFields()[0].setState(e);this.UpdateService.open()}},onCancel:function(){this.UpdateService.close()},onAddLine:function(){if(!this.AddNewService){this.AddNewService=new sap.ui.xmlfragment("com.ServicesProviders.ServicesProviders.fragments.AddNewService",this);this.getView().addDependent(this.AddNewService)}this.AddNewService.open()},onCancelNewService:function(){this.AddNewService.close();this.AddNewService.getContent()[0].getFormContainers()[0].getFormElements()[0].getFields()[0].setValue();this.AddNewService.getContent()[0].getFormContainers()[0].getFormElements()[2].getFields()[0].setSelectedKey();this.AddNewService.getContent()[0].getFormContainers()[0].getFormElements()[1].getFields()[0].setValue("")},onSave:function(){var e=this;const t=e.getOwnerComponent().getModel("SproviderModel");const o=Date.now();const i=`/Date(${o})/`;var s=this.AddNewService.getContent()[0].getFormContainers()[0].getFormElements()[0].getFields()[0].getValue();var n=this.AddNewService.getContent()[0].getFormContainers()[0].getFormElements()[2].getFields()[0].getSelectedKey();if(!s||!n){r.error("Service or Category Not Selected")}else{var a=t.sServiceUrl;var l="/SERVICESMASTER?$filter=startswith(tolower(SERVICE_NAME),tolower('"+s+"')) or startswith(tolower(SERVICECATEGORY_ID),('"+n+"'))";$.ajax({url:a+l,method:"GET",dataType:"json",success:function(o){e.aResults=o.d.results;var a=false;e.aResults.forEach(function(e){if(e.SERVICE_NAME.toLowerCase()===s.toLowerCase()){a=true}});if(!s||!n){r.error("Service or Service ID Cannot be empty",{icon:sap.m.MessageBox.Icon.ERROR,title:"Information",actions:[r.Action.OK]})}else if(a){r.error("Service already exists",{icon:sap.m.MessageBox.Icon.ERROR,title:"Information",actions:[r.Action.OK]})}else{var l="/ServiceProviderOdata/SDR/ServiceProviders/Application/Services_seq.xsjs";$.ajax({url:l,method:"GET",dataType:"json",success:function(o){e.highestID=parseInt(o[0].VALUE);var s={SERVICE_ID:e.highestID,SERVICE_NAME:e.AddNewService.getContent()[0].getFormContainers()[0].getFormElements()[0].getFields()[0].getValue(),SERVICE_DESCRIPTION:e.AddNewService.getContent()[0].getFormContainers()[0].getFormElements()[1].getFields()[0].getValue(),SERVICECATEGORY_ID:e.AddNewService.getContent()[0].getFormContainers()[0].getFormElements()[2].getFields()[0].getSelectedKey(),CREATIONDATETIME:i,CREATEDBY:sap.ushell.Container.getService("UserInfo").getFullName(),UPDATEDATETIME:null,UPDATEDBY:null,DELETIONFLAG:""};e.AddNewService.close();t.create("/SERVICESMASTER",s,{success:function(t){r.success("Service Created Successfully",{onClose:function(){e.AddNewService.getContent()[0].getFormContainers()[0].getFormElements()[0].getFields()[0].setValue("");e.AddNewService.getContent()[0].getFormContainers()[0].getFormElements()[2].getFields()[0].setSelectedKey();e.AddNewService.getContent()[0].getFormContainers()[0].getFormElements()[1].getFields()[0].setValue("");e.getView().byId("servicesTable").getBinding("rows").refresh()}})},error:function(e){console.error("Error creating provider:",e);r.error("An error occurred while creating the Service.")}})},error:function(){}})}},error:function(e){console.error("Error fetching data:",e);r.error("An error occurred while checking for provider existence.")}})}},onUpdate:function(){var e=this;var t=this.selectedItem.SERVICE_ID;const o=Date.now();const i=`/Date(${o})/`;const s=this.getOwnerComponent().getModel("SproviderModel");var n=s.sServiceUrl;var a=this.UpdateService.getContent()[0].getFormContainers()[0].getFormElements()[0].getFields()[0].getValue();var l=this.UpdateService.getContent()[0].getFormContainers()[0].getFormElements()[2].getFields()[0].getSelectedKey();var c=`/SERVICESMASTER?$filter=startswith(tolower(SERVICE_NAME),tolower('${a}')) or startswith(tolower(SERVICECATEGORY_ID),tolower('${l}'))`;var d=false;if(!a||!l){r.information("Servoce or Category ID Cannot be Empty")}else{$.ajax({url:n+c,method:"GET",dataType:"json",success:function(o){e.aResults=o.d.results;e.aResults.forEach(function(e){if(e.SERVICE_ID===t){return}if(e.SERVICE_NAME.toLowerCase()===a.toLowerCase()){d=true}});if(d){r.error("Service or Category ID already Exists",{icon:r.Icon.ERROR,title:"Information",actions:[r.Action.OK]})}else{var n={SERVICE_ID:e.selectedItem.SERVICE_ID,SERVICE_NAME:e.UpdateService.getContent()[0].getFormContainers()[0].getFormElements()[0].getFields()[0].getValue(),SERVICE_DESCRIPTION:e.UpdateService.getContent()[0].getFormContainers()[0].getFormElements()[1].getFields()[0].getValue(),SERVICECATEGORY_ID:e.UpdateService.getContent()[0].getFormContainers()[0].getFormElements()[2].getFields()[0].getSelectedKey(),CREATIONDATETIME:e.selectedItem.CREATIONDATETIME,CREATEDBY:e.selectedItem.CREATEDBY,UPDATEDATETIME:i,UPDATEDBY:sap.ushell.Container.getService("UserInfo").getFullName(),DELETIONFLAG:e.UpdateService.getContent()[0].getFormContainers()[0].getFormElements()[3].getFields()[0].getState()?"X":""};e.UpdateService.close();s.update("/SERVICESMASTER("+e.selectedItem.SERVICE_ID+")",n,{success:function(t,o){e.getView().byId("servicesTable").getBinding("rows").refresh();r.success("Service Updated Successfully")},error:function(e){}})}},error:function(){}})}}})});